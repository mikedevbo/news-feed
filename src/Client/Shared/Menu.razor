@using NewsFeed.Shared
@inject StateContainer StateContainer
@inject HttpClient Http

@{
    var groups = this.accounts.GroupBy(acc => acc.GroupName);
}
<aside class="menu">
    @foreach  (var group in groups)
    {
        <p class="menu-label">@group.Key</p>
        <ul class="menu-list">
            @foreach  (var account in group)
            {
                <li>
                    <nav class="level is-mobile">
                        <div class="level-left">
                            <div class="level-item"><a class="@(account.IsActive ? "is-active" : string.Empty)" @onclick="() => SetAccountAsSelected(account)">@account.Id</a></div>
                            <div class="level-item" @onclick="() => DownloadNewTweets(account)"><a>get</a></div>
                        </div>
                    </nav>
                </li>
            }
        </ul>
    }
</aside>

@code {

    private List<ViewModel.Account> accounts = new List<ViewModel.Account>();

    protected override async Task OnInitializedAsync()
    {
        var accounts = await Http.GetFromJsonAsync<List<Account>>("NewsFeed/GetAccounts");
        if (accounts is not null)
        {
            this.accounts.AddRange(ViewModel.Map(accounts));
        }
    }

    public void SetAccountAsSelected(ViewModel.Account account)
    {
        var prev = (from acc in this.accounts where acc.Id == StateContainer.SelectedAccountId select acc).FirstOrDefault();

        if (prev != null)
        {
            prev.IsActive = false;
        }

        var current = (from acc in this.accounts where acc.Id == account.Id select acc).FirstOrDefault();

        if (current != null)
        {
            current.IsActive = true;
            this.StateContainer.SelectedAccountId = account.Id;
        }
    }

    public void DownloadNewTweets(ViewModel.Account account)
    {
        this.StateContainer.SelectedAccountIdDownloadNewTweets = account.Id;
    }

    public static class ViewModel
    {
        public class Account
        {
            public string Id { get; set; } = "";
            public string GroupName { get; set; } = "";
            public bool IsActive { get; set; }
        }

        public static List<Account> Map(List<NewsFeed.Shared.Account> accounts)
        {
            var result = new List<Account>();

            foreach  (var model in accounts)
            {
                result.Add(new Account
                    {
                        Id = model.Id,
                        GroupName = model.GroupName,
                        IsActive = false
                    });
            }

            return result;
        }
    }
}
